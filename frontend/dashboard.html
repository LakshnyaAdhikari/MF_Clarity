<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | MF-Clarity</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
        }

        .sidebar {
            height: fit-content;
        }

        .explanation-box {
            background: rgba(0, 242, 234, 0.05);
            border-left: 4px solid var(--color-primary);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 4px;
        }

        .market-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 1rem;
        }

        .market-OVERHEATED {
            background: #ff4444;
            color: white;
        }

        .market-NEUTRAL {
            background: #ffbb33;
            color: black;
        }

        .market-UNDERVALUED {
            background: #00C851;
            color: white;
        }

        /* Chat Widget */
        .chat-widget {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .chat-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--color-primary);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 242, 234, 0.4);
            transition: 0.3s;
        }

        .chat-btn:hover {
            transform: scale(1.1);
        }

        .chat-window {
            width: 350px;
            height: 500px;
            background: #1a202c;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-bottom: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .chat-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        .chat-body {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .chat-in {
            display: flex;
            padding: 0.8rem;
            border-top: 1px solid var(--glass-border);
            gap: 0.5rem;
        }

        .chat-in input {
            flex: 1;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.2);
            color: white;
        }

        .msg {
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            max-width: 85%;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .msg-user {
            align-self: flex-end;
            background: var(--color-primary);
            color: black;
        }

        .msg-ai {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .confidence-meter {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--color-text-dim);
        }

        .conf-val {
            color: var(--color-primary);
            font-weight: bold;
        }

        @media(max-width: 900px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }

        .section-header {
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 0.5rem;
            color: var(--color-primary);
        }

        /* Expandable Card Styles */
        .fund-card {
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .fund-card:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .fund-details-panel {
            margin-top: 1rem;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            display: none;
            font-size: 0.95rem;
            border: 1px solid var(--glass-border);
        }

        .fund-details-panel.open {
            display: block;
            animation: fadeIn 0.3s;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .metric-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 0.5rem;
            border-radius: 4px;
            text-align: center;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--color-text-dim);
        }

        .metric-val {
            font-weight: bold;
            color: var(--color-text-light);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <nav class="glass-nav">
        <div class="logo">MF-Clarity <span style="font-size:0.8rem; opacity:0.7;">Dashboard</span></div>
        <div class="nav-links">
            <button id="logout-btn" class="btn-secondary">Logout</button>
        </div>
    </nav>

    <div class="dashboard-container">
        <!-- Input Sidebar -->
        <aside class="sidebar glass-panel">
            <h3>Your Profile</h3>
            <form id="dash-form">
                <div class="form-group">
                    <label>Age</label>
                    <input type="number" name="age" value="30" min="18" max="100">
                </div>

                <div class="form-group">
                    <label>Investment Amount (‚Çπ)</label>
                    <input type="number" name="amount" value="100000" min="1000">
                </div>

                <div class="form-group">
                    <label>Existing Investments (‚Çπ)</label>
                    <input type="number" name="current_investments" value="0" min="0">
                </div>

                <div class="form-group">
                    <label>Goal Horizon (Years)</label>
                    <input type="number" name="horizon_years" value="5" min="1" max="30">
                </div>

                <div class="form-group">
                    <label>Primary Goal</label>
                    <div class="radio-group" style="flex-wrap: wrap;">
                        <label><input type="radio" name="goal" value="Wealth" checked> Wealth</label>
                        <label><input type="radio" name="goal" value="Retirement"> Retirement</label>
                        <label><input type="radio" name="goal" value="Tax"> Tax Save</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Risk Tolerance</label>
                    <div class="radio-group">
                        <label><input type="radio" name="risk_tolerance" value="Low"> Low</label>
                        <label><input type="radio" name="risk_tolerance" value="Moderate" checked> Med</label>
                        <label><input type="radio" name="risk_tolerance" value="High"> High</label>
                    </div>
                </div>

                <button type="submit" class="btn-primary full-width">Analyze & Recommend</button>
            </form>
        </aside>

        <!-- Main Content -->
        <main id="main-content">
            <div id="initial-state" style="text-align: center; padding: 4rem;">
                <h2>Welcome Back!</h2>
                <p>Fill out your profile on the left to get a personalized portfolio recommendation.</p>
            </div>

            <div id="results-view" class="hidden">
                <div class="glass-panel" style="margin-bottom: 2rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                        <h2>Strategy Analysis</h2>
                        <div style="text-align:right;">
                            <div id="market-phase-badge"></div>
                            <div class="confidence-meter">
                                Confidence: <span class="conf-val" id="conf-score">--</span>
                                (<span id="conf-label">--</span>)
                            </div>
                        </div>
                    </div>

                    <!-- Investment Breakdown Box -->
                    <div
                        style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius:8px; margin-bottom:1rem; display:flex; gap:2rem;">
                        <div>
                            <small style="color:var(--color-text-dim)">Lump Sum Investment</small>
                            <div style="font-size:1.4rem; font-weight:bold;">‚Çπ<span id="lump-val">0</span></div>
                        </div>
                        <div>
                            <small style="color:var(--color-text-dim)">Suggested Monthly SIP</small>
                            <div style="font-size:1.4rem; font-weight:bold; color:var(--color-secondary);">‚Çπ<span
                                    id="sip-val">0</span></div>
                        </div>
                    </div>

                    <div id="explanation-text" style="line-height: 1.6; color: var(--color-text-dim);"></div>
                </div>

                <div class="results-grid">
                    <div class="allocation-chart glass-panel">
                        <h3>Asset Allocation</h3>
                        <div class="donut" id="allocation-donut"></div>
                        <div class="legend" id="allocation-legend"></div>
                    </div>

                    <div class="fund-list" id="fund-list">
                        <!-- Funds injected Here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget">
        <div id="chat-window" class="chat-window hidden">
            <div class="chat-header">
                <span>AI Assistant</span>
                <span style="cursor:pointer;" onclick="toggleChat()">√ó</span>
            </div>
            <div class="chat-body" id="chat-body">
                <div class="msg msg-ai">Hi! I can explain your portfolio or run simulations. Ask me anything!</div>
            </div>
            <div class="chat-in">
                <input type="text" id="chat-input" placeholder="Type a message...">
                <button onclick="sendChat()" style="padding:0.2rem 0.8rem;">‚Üí</button>
            </div>
        </div>
        <button class="chat-btn" onclick="toggleChat()">üí¨</button>
    </div>

    <script>
        // Check Auth
        const token = localStorage.getItem('access_token');
        if (!token) window.location.href = 'login.html';

        let currentPortfolio = null; // Store for Context

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('access_token');
            window.location.href = 'landing.html';
        });

        // Chat Logic
        function toggleChat() {
            const win = document.getElementById('chat-window');
            if (win.classList.contains('hidden')) {
                win.classList.remove('hidden');
                // Auto focus logic if needed
            } else {
                win.classList.add('hidden');
            }
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            // User Msg
            addMsg(msg, 'user');
            input.value = '';

            try {
                const payload = {
                    message: msg,
                    context: currentPortfolio ? { funds: currentPortfolio.portfolio } : null
                };

                const res = await fetch('http://127.0.0.1:8000/chat/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                addMsg(data.response, 'ai');
            } catch (err) {
                addMsg("Error connecting to AI.", 'ai');
            }
        }

        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg msg-${type}`;
            div.innerText = text;
            const body = document.getElementById('chat-body');
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        document.getElementById('dash-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const payload = Object.fromEntries(formData.entries());

            // Type conversion
            payload.amount = parseFloat(payload.amount);
            payload.age = parseInt(payload.age);
            payload.horizon_years = parseFloat(payload.horizon_years);
            payload.current_investments = parseFloat(payload.current_investments);

            const btn = e.target.querySelector('button');
            const oldText = btn.innerText;
            btn.innerText = "Analyzing...";
            btn.disabled = true;

            try {
                const res = await fetch('http://127.0.0.1:8000/recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(payload)
                });

                if (res.status === 401) {
                    alert('Session expired. Please login again.');
                    window.location.href = 'login.html';
                    return;
                }

                if (!res.ok) throw new Error('Failed to fetch');

                const data = await res.json();
                currentPortfolio = data; // Save context
                renderDashboard(data);

            } catch (err) {
                console.error(err);
                alert('Analysis failed. Ensure backend is running.');
            } finally {
                btn.innerText = oldText;
                btn.disabled = false;
            }
        });

        function renderDashboard(data) {
            document.getElementById('initial-state').classList.add('hidden');
            document.getElementById('results-view').classList.remove('hidden');

            // 1. Market Phase & Explanation
            const phase = data.market_status.phase;
            const badge = document.getElementById('market-phase-badge');
            badge.className = `market-badge market-${phase}`;
            badge.innerText = `Market: ${phase}`;

            // Confidence Score
            document.getElementById('conf-score').innerText = data.confidence_score + '%';
            document.getElementById('conf-label').innerText = data.stability_label || 'High';

            // Investment Breakdown
            if (data.breakdown) {
                document.getElementById('lump-val').innerText = data.breakdown.lump_sum_total.toLocaleString('en-IN');
                document.getElementById('sip-val').innerText = data.breakdown.sip_total.toLocaleString('en-IN');
            }

            // Explanation
            let exp = data.explanation.replace(/\*\*(.*?)\*\*/g, '<strong style="color:var(--color-primary)">$1</strong>');
            exp = exp.replace(/\n/g, '<br>');
            document.getElementById('explanation-text').innerHTML = exp;

            // 2. Chart
            const equityPct = (data.allocation.Equity * 100).toFixed(0);
            const debtPct = (data.allocation.Debt * 100).toFixed(0);
            const donut = document.getElementById('allocation-donut');
            donut.style.background = `conic-gradient(var(--color-primary) 0% ${equityPct}%, var(--color-secondary) ${equityPct}% 100%)`;

            document.getElementById('allocation-legend').innerHTML = `
                <div style="margin-top:1rem; text-align:center;">
                    <span style="color:var(--color-primary)">‚óè Equity ${equityPct}%</span>
                    <span style="color:var(--color-secondary); margin-left:1rem;">‚óè Debt ${debtPct}%</span>
                </div>
            `;

            // 3. Top Funds List (Sectioned)
            const list = document.getElementById('fund-list');
            list.innerHTML = '';

            // Helper to render section
            const renderSection = (title, items) => {
                if (!items || items.length === 0) return;
                const h = document.createElement('h4');
                h.className = 'section-header';
                h.innerText = title;
                list.appendChild(h);

                items.forEach((item, index) => {
                    const uniqueId = `fund-detail-${index}-${Math.random().toString(36).substr(2, 9)}`;
                    const metrics = item.metrics || { sharpe: '-', volatility: '-', returns: '-' };

                    const div = document.createElement('div');
                    div.className = 'fund-card';
                    div.onclick = (e) => {
                        // Prevent toggling if clicking a specific button (future proofing)
                        const panel = document.getElementById(uniqueId);
                        panel.classList.toggle('open');
                    };

                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap: 1rem;">
                            <div class="fund-info" style="flex: 1; max-width: 75%;">
                                <h4 style="margin:0; line-height:1.2; word-wrap: break-word;">${item.fund_name || item.fund_id}</h4>
                                <div class="meta" style="margin-top:0.4rem;">
                                    <span class="fund-badge">${item.category}</span>
                                    <span style="font-size:0.8rem; color:var(--color-text-dim); display:inline-block; margin-top:0.2rem;">Alloc: ${(item.weight * 100).toFixed(1)}% (‚Çπ${item.amount.toLocaleString('en-IN')})</span>
                                </div>
                            </div>
                            <div class="fund-score" style="flex-shrink: 0; min-width: 60px; text-align: right; margin-left: 1rem;">
                                <div style="font-size:0.8rem; color:var(--color-text-dim)">Score</div>
                                <div class="score-val" style="font-size:1.4rem; line-height: 1;">${(item.score * 100).toFixed(0)}</div>
                            </div>
                        </div>` + `
                        
                        <!-- DETAILS PANEL -->
                        <div id="${uniqueId}" class="fund-details-panel">
                            <div class="metrics-grid">
                                <div class="metric-box">
                                    <div class="metric-label">1Y Returns</div>
                                    <div class="metric-val" style="color:var(--color-secondary);">${metrics.returns}%</div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">Volatility</div>
                                    <div class="metric-val">${metrics.volatility}%</div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">Sharpe Ratio</div>
                                    <div class="metric-val">${metrics.sharpe}</div>
                                </div>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--color-text-dim); margin-bottom:0.5rem;">
                                <strong>Why this fund?</strong><br>
                                ${item.rationale || "Selected based on high risk-adjusted returns."}
                            </div>
                            <!-- Placeholder for Alternatives -->
                            <div style="text-align:right;">
                                <button class="btn-secondary" style="font-size:0.75rem; padding:0.2rem 0.6rem;" onclick="event.stopPropagation(); alert('Alternatives feature coming soon!')">Find Alternatives</button>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            };

            // Use 'sections' if available, else fall back to 'portfolio'
            if (data.sections) {
                renderSection('Equity Schemes', data.sections.equity);
                renderSection('Debt Schemes', data.sections.debt);
            } else {
                renderSection('Recommended Funds', data.portfolio);
            }
        }
    </script>
</body>

</html>